<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>性能优化的工具和方法 | blog</title>
    <meta name="description" content="个人博客">
    
    
    <link rel="preload" href="/assets/css/styles.b42abe6f.css" as="style"><link rel="preload" href="/assets/js/app.b42abe6f.js" as="script"><link rel="preload" href="/assets/js/1.dff77059.js" as="script"><link rel="prefetch" href="/assets/css/3.styles.bf21c47b.css"><link rel="prefetch" href="/assets/css/5.styles.f0563a84.css"><link rel="prefetch" href="/assets/js/10.e076944d.js"><link rel="prefetch" href="/assets/js/11.546c13ea.js"><link rel="prefetch" href="/assets/js/12.e693a965.js"><link rel="prefetch" href="/assets/js/13.50ec98f6.js"><link rel="prefetch" href="/assets/js/14.5c132dbd.js"><link rel="prefetch" href="/assets/js/15.039f8dfe.js"><link rel="prefetch" href="/assets/js/16.52cd6bf5.js"><link rel="prefetch" href="/assets/js/17.8d8830f0.js"><link rel="prefetch" href="/assets/js/18.88f8360a.js"><link rel="prefetch" href="/assets/js/19.181e6c64.js"><link rel="prefetch" href="/assets/js/2.09ff0bcc.js"><link rel="prefetch" href="/assets/js/20.df164712.js"><link rel="prefetch" href="/assets/js/21.a9f9460b.js"><link rel="prefetch" href="/assets/js/22.357eb161.js"><link rel="prefetch" href="/assets/js/23.8dec52be.js"><link rel="prefetch" href="/assets/js/24.7789a075.js"><link rel="prefetch" href="/assets/js/25.798012ae.js"><link rel="prefetch" href="/assets/js/26.8c84aa29.js"><link rel="prefetch" href="/assets/js/27.7e6b0680.js"><link rel="prefetch" href="/assets/js/28.743d4aec.js"><link rel="prefetch" href="/assets/js/29.25a6342c.js"><link rel="prefetch" href="/assets/js/3.bf21c47b.js"><link rel="prefetch" href="/assets/js/30.f89ccfdd.js"><link rel="prefetch" href="/assets/js/31.ce84809e.js"><link rel="prefetch" href="/assets/js/32.ef7d6946.js"><link rel="prefetch" href="/assets/js/4.b5d345c2.js"><link rel="prefetch" href="/assets/js/5.f0563a84.js"><link rel="prefetch" href="/assets/js/6.d781e65a.js"><link rel="prefetch" href="/assets/js/7.90f4fe36.js"><link rel="prefetch" href="/assets/js/8.40fecd53.js"><link rel="prefetch" href="/assets/js/9.e050a938.js">
    <link rel="stylesheet" href="/assets/css/styles.b42abe6f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">前言</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架通识</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据结构和算法</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>项目中的问题</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/src/work/home.html" class="sidebar-link">工作项目中遇到的问题</a></li><li><a href="/src/work/Lighthouse.html" aria-current="page" class="active sidebar-link">性能优化的工具和方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/src/work/Lighthouse.html#lighthouse" class="sidebar-link">Lighthouse</a></li></ul></li><li><a href="/src/work/Performance.html" class="sidebar-link">Performance</a></li><li><a href="/src/work/ReactProfiler.html" class="sidebar-link">React Profiler</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="性能优化的工具和方法"><a href="#性能优化的工具和方法" class="header-anchor">#</a> 性能优化的工具和方法</h1> <p>性能优化是前端开发中一个非常重要的组成部分，比如 如何更好地进行网络传输，如何优化浏览器渲染过程，那么怎么来定位项目中存在的问题呢？</p> <p>Chrome DevTools 给我们提供了 2 种常用方式：</p> <ul><li>Lighthouse：可以对页面进行性能评分，同时还会给出一些优化建议</li> <li>Performance：分析运行时性能。比如页面的响应、动画和空闲阶段。</li></ul> <p>React 项目还可以利用</p> <ul><li>Profiler：官方提供的性能分析插件，收集每个组件渲染的耗时，用于分析识别出 React 应用中的性能瓶颈</li></ul> <p>在隐身模式下打开谷歌浏览器。隐身模式可确保 Chrome 以干净的状态运行。例如，如果您安装了很多扩展，这些扩展可能会在您的性能测量中产生干扰</p> <h2 id="lighthouse"><a href="#lighthouse" class="header-anchor">#</a> Lighthouse</h2> <p>根据 Google Developers Docs 上的描述</p> <blockquote><p>Lighthouse 是一种开源的自动化工具，用于提高网页质量。你可以在任何网页上运行它。它能够针对性能、可访问性、渐进式 Web 应用等进行审核。<br>
你可以在 Chrome DevTools 中从命令行运行 Lighthouse。当你向 Lighthouse 提供了一个 URL 来进行审核时，它会针对该页面运行一系列审核，然后生成一个关于该页面执行情况的报告。这份报告可以作为如何改进页面的指标。每次审核都会产生一份参考文档，解释了这些审核为什么重要，以及如何解决等内容。</p></blockquote> <p>目前测试项包括页面性能、PWA、可访问性（无障碍）、最佳实践、SEO。<br>
Lighthouse 会对各个测试项的结果打分，并给出优化建议，这些打分标准和优化建议可以视为 Google 的网页最佳实践。</p> <p>步骤：</p> <ol><li>单击 Lighthouse 选项卡。它可能隐藏在“更多面板” 按钮后面</li> <li>将您的 Lighthouse 配置设置与下图中的设置相匹配</li></ol> <p><img src="/assets/img/18.013f3407.png" alt="image"></p> <p>以下是对不同选项的解释：</p> <ul><li>device（设备）：设置为 Mobile 会更改用户代理字符串并模拟移动视口。设置为桌面几乎只是禁用移动更改。</li> <li>categories(种类)：禁用某个类别会阻止审核面板运行这些审核，并将这些审核从您的报告中排除。如果您想查看其他类别提供的推荐类型，您可以启用其他类别。禁用类别会稍微加快审核过程。</li></ul> <p>单击 <code>生成报告</code>，10 到 30 秒后，审核面板会向您显示站点性能报告。</p> <h3 id="以群侧边栏首页为例，通过-lighthouse-对页面进行性能评分"><a href="#以群侧边栏首页为例，通过-lighthouse-对页面进行性能评分" class="header-anchor">#</a> 以群侧边栏首页为例，通过 Lighthouse 对页面进行性能评分</h3> <p><img src="/assets/img/6.b7debe2f.png" alt="image"></p> <p>报告顶部的数字是网站的整体性能得分。稍后，当您对代码进行更改时，您应该会看到这个数字上升。更高的分数意味着更好的性能。</p> <p>该指标部分提供了网站的性能的定量测量。每个指标都提供了对性能不同方面的洞察。例如，First Contentful Paint 会告诉您内容何时首次绘制到屏幕上，这是用户感知页面加载的一个重要里程碑，而 Time To Interactive 标志着页面似乎已准备好处理用户交互的时间点。</p> <h3 id="opportunities（优化建议）"><a href="#opportunities（优化建议）" class="header-anchor">#</a> opportunities（优化建议）</h3> <p>在 opportunities 部分提供了关于如何提高这个特定页面的加载性能的具体建议。</p> <p><img src="/assets/img/7.184c04ae.png" alt="image"></p> <h3 id="根据-opportunities-实践"><a href="#根据-opportunities-实践" class="header-anchor">#</a> 根据 opportunities 实践</h3> <h4 id="一、enable-text-compression（压缩文本）"><a href="#一、enable-text-compression（压缩文本）" class="header-anchor">#</a> 一、Enable text compression（压缩文本）</h4> <blockquote><p>Text-based resources should be served with compression (gzip, deflate or brotli) to minimize total network bytes.<br>
文本压缩：在通过网络发送文本文件之前减小或压缩文本文件的大小。有点像您如何在通过电子邮件发送文件夹之前压缩文件夹以减小其大小。</p></blockquote> <p>单击<a href="https://web.dev/uses-text-compression/?utm_source=lighthouse&utm_medium=devtools" target="_blank" rel="noopener noreferrer">了解更多<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，以查看有关 opportunity 为何重要的文档，以及有关如何修复它的具体建议。</p> <p><img src="/assets/img/19.47ed423c.png" alt="image"></p> <p><strong>在启用压缩之前，您可以通过以下几种方法手动检查文本资源是否已压缩</strong></p> <ol><li>单击 network 选项卡</li> <li>单击 use large request rows 使用大请求行。网络请求表中行的高度增加</li> <li>如果在网络请求表中没有看到 Size 列，请单击表标题，然后选择 Size</li></ol> <p>每个大小单元格显示两个值。最高值是下载资源的大小。底部值是未压缩资源的大小。如果这两个值相同，则资源在通过网络发送时不会被压缩。</p> <p><img src="/assets/img/25.fde992c7.png" alt="image"></p> <p><strong>您还可以通过检查资源的 HTTP 标头来检查压缩：</strong></p> <ol><li>单击 chunk.js。</li> <li>单击标题选项卡。</li> <li>在响应标题部分搜索 content-encoding 标题。你不应该看到一个，这意味着它 bundle.js 没有被压缩。当资源被压缩，这头一般设置为 gzip，deflate 或 br。有关这些值的解释，请参阅指令。</li></ol> <p><img src="/assets/img/24.48083309.png" alt="image"></p> <p><strong>方法：</strong></p> <ol><li>Install gzipper package (<a href="https://www.npmjs.com/package/gzipper" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/gzipper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)<br> <code>gzipper compress [options] &lt;path&gt; [outputPath]</code></li> <li>Modify build command like this in package.json</li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code>- <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node scripts/build.js&quot;</span>
+ <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node scripts/build.js &amp;&amp; gzipper compress --verbose ./build&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>运行 <code>npm run build</code> 后</p> <p><img src="/assets/img/22.45ba7b3b.png" alt="image"></p> <p>build your project you will get both gzip and regular file. It is up to you to make server to serve gzip instead of regular file. If you are using nginx you have to setup your server in nginx.conf file as below</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
    # Gzip Settings
    gzip on;
    gzip_static on; # allows pre-serving of .gz file if it exists
    gzip_disable &quot;msie6&quot;; # Disable for user-agent Internet explorer 6. Not supported.
    gzip_proxied any; # enable gzip for all proxied requests
    gzip_buffers 16 8k; # number and size of buffers to compress a response
    gzip_http_version 1.1;
    gzip_min_length 256; # Only gzip files of size in bytes
    gzip_types text/plain text/css text/html application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;
    gunzip on; # Uncompress on the fly
    listen       80;
    server_name  localhost;

    ...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>参考资料：<br> <a href="https://stackoverflow.com/questions/55704772/how-to-compress-build-with-without-ejecting-create-react-app-also-include-compr" target="_blank" rel="noopener noreferrer">解决方案参照<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://www.cnblogs.com/54chensongxia/p/13355054.html" target="_blank" rel="noopener noreferrer">Nginx 的 Gzip 功能<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="二、reduce-unused-javascript"><a href="#二、reduce-unused-javascript" class="header-anchor">#</a> 二、Reduce unused JavaScript</h4> <blockquote><p>Reduce unused JavaScript and defer loading scripts until they are required to decrease bytes consumed by network activity.</p></blockquote> <p><strong>React 项目，用 React.lazy() 结合 Suspense</strong></p> <blockquote><p>参见 React 官方文档：<br>
not server-side rendering： React.lazy() + Suspense with a defined fallback, Otherwise, code-split using a third-party library such as loadable-components.</p></blockquote> <p>React.lazy() 和 Suspense 配合使用</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Suspense<span class="token punctuation">,</span> lazy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token keyword">as</span> Router<span class="token punctuation">,</span> Route<span class="token punctuation">,</span> Switch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/Home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> About <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/About&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Router<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Suspense fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Switch<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route exact path<span class="token operator">=</span><span class="token string">&quot;/&quot;</span> component<span class="token operator">=</span><span class="token punctuation">{</span>Home<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">&quot;/about&quot;</span> component<span class="token operator">=</span><span class="token punctuation">{</span>About<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Suspense<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>Router<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>参考资料：<br> <a href="https://reactjs.org/docs/code-splitting.html#route-based-code-splitting" target="_blank" rel="noopener noreferrer">React Docs on code splitting<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>Build tool for support for Code Splitting</strong></p> <p>代码分割是由诸如 Webpack，Rollup 和 Browserify（factor-bundle）这类打包器支持的一项技术，能够创建多个包并在运行时动态加载。<br>
可以避免加载用户永远不需要的代码，并在初始加载的时候减少所需加载的代码量</p> <p>webpack 的常见做法：</p> <ul><li><strong>入口起点：在 entry 里配置多个入口，使用 entry 配置手动地分离代码。比如分离业务代码和第三方库（ vendor ）</strong></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    app<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    vendor<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;src/vendor.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><strong>防止重复：使用 Entry dependencies 或者 SplitChunksPlugin 去重和分离 chunk</strong></li></ul> <p>问题：以 index.js 为例，——部分的修改意味着重新下载所有的文件</p> <p>所以为什么不把每一个 npm 包都分割为单独的文件呢？<br>
做起来非常简单，利用 Webpack 的 splitChunks，让我们把我们的 react，lodash 等分离为不同的文件</p> <p>splitChunks 配置分离规则如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    app<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">&quot;[name].[contenthash].js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 表示选择哪些 chunks 进行分割，可选值有：async，initial和all</span>
      chunks<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
      <span class="token comment">// 表示加载入口文件时，并行请求的最大数目。默认为3。</span>
      maxInitialRequests<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token comment">// 表示新分离出的chunk必须大于等于minSize，默认为30000，约30kb。</span>
      minSize<span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
      <span class="token comment">/*
      cacheGroups是我们用来制定规则告诉 Webpack 应该如何组织 chunks 到打包输出文件的地方。
      cacheGroups 下可以配置多个组，每个组根据test设置条件，符合test条件的模块，就分配到该组。
      模块可以被多个组引用，但最终会根据priority来决定打包到哪个组中。

      通常情况下，只需要为输出文件的 name定义一个字符串。但是把name定义为一个函数（当文件被解析时会被调用）。在函数中会根据 module 的路径返回包的名称。结果就是，对于每一个包都会得到一个单独的文件，比如npm.react-dom.899sadfhj4.js

    */</span>
      cacheGroups<span class="token operator">:</span> <span class="token punctuation">{</span>
        atm<span class="token operator">:</span> <span class="token punctuation">{</span>
          test<span class="token operator">:</span> <span class="token string">&quot;/antd-mobile/&quot;</span><span class="token punctuation">,</span>
          priority<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        milo<span class="token operator">:</span> <span class="token punctuation">{</span>
          test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">milo-ui</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          priority<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        vendor<span class="token operator">:</span> <span class="token punctuation">{</span>
          test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// get the name. E.g. node_modules/packageName/not/this/part.js</span>
            <span class="token comment">// or node_modules/packageName</span>
            <span class="token keyword">const</span> packageName <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>
              <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/](.*?)([\\/]|$)</span><span class="token regex-delimiter">/</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment">// npm package names are URL-safe, but some servers don't like @ symbols</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;@&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          reuseExistingChunk<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 将两个以上的chunk所共享的模块打包至default组</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          minChunks<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          reuseExistingChunk<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>修改前打包后的 js 文件目录：</p> <p><img src="/assets/img/9.526e1e7d.png" alt="image"></p> <p>修改后打包后的 js 文件目录：</p> <p><img src="/assets/img/8.3525c420.png" alt="image"></p> <ul><li><strong>动态导入：通过模块的内联函数调用来分离代码</strong> <blockquote><p>kindly remind: 这里只是一个示例，lodash 可以用支持模块化导入的 lodash-es 代替</p></blockquote></li></ul> <p>示例：<br>
我们不再使用 statically import(静态导入) lodash，而是通过 dynamic import(动态导入) 来分离出一个 chunk：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> _ <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;webpack&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在修改后，会分离出一个独立的 lodash 文件：<br> <img src="/assets/img/11.1aba79a1.png" alt="image"></p> <ul><li><strong>Unused Code Elimination &amp; Unused Imported Code</strong></li></ul> <p>利用 webpack 的 <a href="https://webpack.js.org/guides/tree-shaking" target="_blank" rel="noopener noreferrer">Tree Shaking<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，去除 unused code</p> <blockquote><p>参见 webpack4 文档：<br>
Tree shaking is a term commonly used in the JavaScript context for dead-code elimination. It relies on the static structure of ES2015 module syntax, i.e. import and export. The name and concept have been popularized by the ES2015 module bundler rollup.</p></blockquote> <blockquote><p>The webpack 2 release came with built-in support for ES2015 modules (alias harmony modules) as well as unused module export detection. The new webpack 4 release expands on this capability with a way to provide hints to the compiler via the &quot;sideEffects&quot; package.json property to denote which files in your project are &quot;pure&quot; and therefore safe to prune if unused.</p></blockquote> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ml-wxwork-assistant&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>修改后打包后的 js 文件目录：</p> <p><img src="/assets/img/10.ffdfda76.png" alt="image"></p> <p>对比发现有些文件小了一些</p> <p>参考资料：<br> <a href="https://web.dev/unused-javascript/" target="_blank" rel="noopener noreferrer">Remove unused JavaScript<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="三、eliminate-render-blocking-resources"><a href="#三、eliminate-render-blocking-resources" class="header-anchor">#</a> 三、Eliminate render-blocking resources</h4> <p><img src="/assets/img/13.e87528f1.png" alt="image"></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;//res.wx.qq.com/open/js/jweixin-1.2.0.js&quot;</span> defer<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在 script 元素中</p> <ul><li>设置 defer 属性（只适用于外部脚本文件）：告诉浏览器立即下载，但延迟执行</li> <li>设置 async 属性：不让页面等待脚本下载和执行，从而异步加载页面其他内容。</li></ul> <h4 id="四-本项目中优化的其他方案"><a href="#四-本项目中优化的其他方案" class="header-anchor">#</a> 四.本项目中优化的其他方案</h4> <p><img src="/assets/img/12.eda9f0bb.png" alt="image"></p> <ul><li>去除 moment.js ，换成其他可以按需加载的时间库</li> <li>在 <code>@mlamp/milo-ui</code> 中去除<code>moment</code>依赖 和 按需加载<code>@ant-design/icons</code></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

<span class="token comment">// tree-shaking supported</span>
<span class="token operator">-</span> <span class="token keyword">import</span> <span class="token punctuation">{</span> Icon <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token keyword">import</span> <span class="token punctuation">{</span> SmileOutlined <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@ant-design/icons'</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">Demo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
<span class="token operator">-</span>     <span class="token operator">&lt;</span>Icon type<span class="token operator">=</span><span class="token string">&quot;smile&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">+</span>     <span class="token operator">&lt;</span>SmileOutlined <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Button icon<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>SmileOutlined <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// or directly import</span>
  <span class="token keyword">import</span> SmileOutlined <span class="token keyword">from</span> <span class="token string">'@ant-design/icons/SmileOutlined'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="诊断（diagnostics）"><a href="#诊断（diagnostics）" class="header-anchor">#</a> 诊断（Diagnostics）</h3> <h4 id="一、serve-static-assets-with-an-efficient-cache-policy"><a href="#一、serve-static-assets-with-an-efficient-cache-policy" class="header-anchor">#</a> 一、Serve static assets with an efficient cache policy</h4> <blockquote><p>A long cache lifetime can speed up repeat visits to your page. <a href="https://web.dev/uses-long-cache-ttl/?utm_source=lighthouse&utm_medium=devtools" target="_blank" rel="noopener noreferrer">Learn more<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></blockquote> <p><img src="/assets/img/23.4f8c012a.png" alt="image"></p> <p>浏览器中的 cache 的三种属性</p> <ol><li>Cache-Control:<br>
no-cache: 代表档案不会被浏览器记住，每次 refresh 后都会重新与 server 要一次资料<br>
max-age: 以秒为单位，当超过 cache 时间，refresh 后会重新与 server 要一次资料</li> <li>Expires<br>
Expires: cache 过期失效的设定，在还没过期前，使用者怎么 refresh 都不会重新与 server 要一次资料。这的确会让 server 压力大大的下降，但大家或许会看出个问题，假设我设定了 365 天的 Expires，当 server 端的档案更新但使用者却要一年之后才会更新怎么办？这时第三个主角就要出现了，我们继续看下去！</li> <li>Last-Modified<br>
当设定此参数之后，每次使用者 refresh 页面后，其实都会偷偷地向 server 下一个请求(非常非常小)，基本上就是确定档案有没有被更新过，如果没有就什么都不做，如果有就更新！</li></ol> <p>解决办法：通过在 nginx 中设定缓存参数</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  location /static {
    # 如果想要缓存所有 static 下的档案(css, js 档案都在其中)
    alias /static;
    # max-age 单位为秒数，在此设定 365 天
    add_header Cache-Control &quot;public, max-age=31536000&quot;;
    # expires 10d 代表着 10 天就会过期，重新要资料。
    expires 10d;
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="二、avoid-enormous-network-payloads"><a href="#二、avoid-enormous-network-payloads" class="header-anchor">#</a> 二、Avoid enormous network payloads</h4> <h4 id="三、avoid-an-excessive-dom-size"><a href="#三、avoid-an-excessive-dom-size" class="header-anchor">#</a> 三、Avoid an excessive DOM size</h4> <p>文件过大</p> <p><img src="/assets/img/17.307f44e2.jpg" alt="image"></p> <h3 id="passed-audits"><a href="#passed-audits" class="header-anchor">#</a> Passed audits</h3> <p><img src="/assets/img/26.0080f513.png" alt="image"><br>
可以大致过一下需要注意的内容，作为参考，在以后的开发工作中注意</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">10/13/2021, 8:42:37 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/src/work/home.html" class="prev">
          工作项目中遇到的问题
        </a></span> <span class="next"><a href="/src/work/Performance.html">
          Performance
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.b42abe6f.js" defer></script><script src="/assets/js/1.dff77059.js" defer></script>
  </body>
</html>
